<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDNS Configuration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007BFF;
            color: white;
        }
        input {
            width: 100%;
            padding: 5px;
            margin: 2px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 8px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button.edit {
            background-color: #007BFF;
        }
        button.delete {
            background-color: #ff0000;
        }
        button:hover {
            opacity: 0.8;
        }
        .settings-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        .settings-card h4 {
            margin-bottom: 10px;
            font-size: 18px;
            color: #333;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        button.primary {
            background-color: #007BFF;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button.secondary {
            background-color: #ff6347;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div style="margin-bottom: 20px;">
        <button onclick="showTab('dashboard')">Dashboard</button>
        <button onclick="showTab('advanced-settings')">Advanced Settings</button>
        <a href="/logout"><button style="background-color: red;">Logout</button></a>
    </div>

    <div id="dashboard" class="tab-content">
        <div class="container">
            <h2>DDNS Entries</h2>
            <table>
                <tr>
                    <th>Domain Name</th>
                    <!-- <th>Config Path</th> -->
                    <th>Protocol</th>
                    <th>IPv6 Address</th>
                    <th>Access Code</th>
                    <th>Actions</th>
                </tr>
                {% for entry in entries %}
                <tr>
                    <td><input type="text" value="{{ entry.domain_name }}" id="domain-{{ loop.index0 }}"></td>
                    <!-- <td><input type="text" value="{{ entry.config_file_path }}" id="path-{{ loop.index0 }}"></td> -->
                    <td><input type="text" value="{{ entry.protocol }}" id="protocol-{{ loop.index0 }}"></td>
                    <td><input type="text" value="{{ entry.ipv6_address or '' }}" id="ipv6-{{ loop.index0 }}"></td>
                    <td><input type="text" value="{{ entry.access_code }}" id="access-{{ loop.index0 }}"></td>
                    <td style="display: flex; align-items: center; gap: 10px;">
                        <button class="edit" onclick="updateEntity({{ loop.index0 }})">Edit</button>
                        <button class="delete" onclick="deleteEntity({{ loop.index0 }})">X</button>
                    </td>
                </tr>
                {% endfor %}
            </table>

            <h3>Add New Entry</h3>
            <input type="text" id="new-domain" placeholder="Domain Name">
            <input type="text" id="new-path" placeholder="Config File Path">
            <input type="text" id="new-protocol" placeholder="Protocol">
            <input type="text" id="new-ipv6" placeholder="IPv6 Address (optional)">
            <input type="text" id="new-access" placeholder="Access Code">
            <button onclick="addEntity()">Add Entry</button>
        </div>
    </div>

    <div id="advanced-settings" class="tab-content" style="display: none;">
        <h3>Advanced Settings</h3>
        
        <div class="settings-card">
            <h4>Nginx Template Settings</h4>
            <label for="nginx-template">Default Nginx Template:</label>
            <textarea id="nginx-template" rows="10">{{ nginx_template }}</textarea>
            <div class="button-group">
                <button class="primary" onclick="updateNginxTemplate()">Submit</button>
                <button class="secondary" onclick="resetNginxTemplate()">Reset to Default</button>
            </div>
        </div>
    </div>

    <script>
        async function updateEntity(index) {
            let formData = new FormData();
            formData.append("index", index);
            formData.append("domain_name", document.getElementById(`domain-${index}`).value);
            formData.append("config_file_path", document.getElementById(`path-${index}`).value);
            formData.append("protocol", document.getElementById(`protocol-${index}`).value);
            formData.append("ipv6_address", document.getElementById(`ipv6-${index}`).value);
            formData.append("access_code", document.getElementById(`access-${index}`).value);

            let response = await fetch("/update_entity", { method: "POST", body: formData });
            let result = await response.json();
            alert(result.message);
        }

        async function addEntity() {
            let formData = new FormData();
            formData.append("domain_name", document.getElementById("new-domain").value);
            formData.append("config_file_path", document.getElementById("new-path").value);
            formData.append("protocol", document.getElementById("new-protocol").value);
            formData.append("ipv6_address", document.getElementById("new-ipv6").value);
            formData.append("access_code", document.getElementById("new-access").value);

            let response = await fetch("/add_entity", { method: "POST", body: formData });
            let result = await response.json();
            alert(result.message);
            location.reload();
        }

        async function deleteEntity(index) {
            if (!confirm("Are you sure you want to delete this entry?")) return;

            fetch("/delete_entity", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ index })
            }).then(response => response.json())
              .then(data => {
                  if (data.message) {
                      alert(data.message);
                      location.reload();
                  } else {
                      alert("Error deleting entity");
                  }
              });
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none'; // Hide all tabs
            });
            document.getElementById(tabId).style.display = 'block'; // Show selected tab
        }

        function updateNginxTemplate() {
            const template = document.getElementById("nginx-template").value;
            fetch("/update_nginx_template", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ template })
            }).then(response => response.json())
              .then(data => alert(data.message));
        }

        function resetNginxTemplate() {
            fetch("/reset_nginx_template", {
                method: "POST"
            }).then(response => response.json())
              .then(data => {
                  document.getElementById("nginx-template").value = data.template;
                  alert(data.message);
              });
        }

        async function fetchAndUpdateNginxTemplate() {
            try {
                let response = await fetch('/get_nginx_template');

                if (response.status === 401) {
                    alert("You are not authorized to access this section. Please log in.");
                    window.location.href = '/';  // Redirect to login page
                    return;
                }

                let data = await response.json();
                document.getElementById('nginx-template').value = data.template; // Update text box
            } catch (error) {
                console.error("Error fetching template:", error);
                alert("Failed to load Nginx template. Please try again.");
            }
        }


    </script>
</body>
</html>
